<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVision AI Futures Trading - Levier 20√ó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- SONS D'ALARME -->
    <audio id="win-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="loss-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-957.mp3" type="audio/mpeg">
    </audio>
    <audio id="limit-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    <style>
        /* ================= VARIABLES & RESET ================= */
        :root {
            --primary: #00d4ff;
            --primary-dark: #0099ff;
            --secondary: #00ff88;
            --danger: #ff416c;
            --warning: #ff9900;
            --futures: #9d4edd;
            --background: #0a0e17;
            --card-bg: #111827;
            --card-border: #1e2a3a;
            --text: #ffffff;
            --text-muted: #8a9bb0;
            --success: #00ff88;
            --gradient-primary: linear-gradient(135deg, #00d4ff, #0099ff);
            --gradient-success: linear-gradient(135deg, #00ff88, #00cc66);
            --gradient-danger: linear-gradient(135deg, #ff416c, #ff4b2b);
            --gradient-warning: linear-gradient(135deg, #ff9900, #ff5500);
            --gradient-futures: linear-gradient(135deg, #9d4edd, #7b2cbf);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* ================= HEADER & NAV ================= */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--card-border);
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 800;
            color: var(--futures);
        }

        .logo i {
            font-size: 28px;
        }

        .lever-badge {
            background: var(--warning);
            color: #000;
            padding: 5px 12px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 14px;
            margin-left: 8px;
            box-shadow: 0 4px 10px rgba(255, 153, 0, 0.3);
        }

        .futures-badge {
            background: var(--gradient-futures);
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 8px;
        }

        .menu {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .menu a {
            color: var(--text-muted);
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            border: 1px solid transparent;
            font-size: 14px;
        }

        .menu a.active,
        .menu a:hover {
            background: rgba(30, 42, 58, 0.6);
            border-color: var(--futures);
            color: var(--futures);
            box-shadow: 0 5px 15px rgba(157, 78, 221, 0.2);
        }

        /* ================= DASHBOARD GRID ================= */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 22px;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            border-color: var(--futures);
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(157, 78, 221, 0.15);
        }

        .card h2 {
            color: var(--futures);
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(30, 42, 58, 0.5);
        }

        /* ================= BALANCE & STATUS ================= */
        .balance {
            font-size: 42px;
            font-weight: 900;
            color: var(--secondary);
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), transparent);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .status {
            padding: 16px;
            border-radius: 12px;
            margin: 18px 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .status-online {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }

        .status-offline {
            background: rgba(255, 65, 108, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        /* ================= BOUTONS ================= */
        .btn {
            background: var(--gradient-futures);
            color: white;
            border: none;
            padding: 15px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
        }

        .btn-green {
            background: var(--gradient-success);
        }

        .btn-red {
            background: var(--gradient-danger);
        }

        .btn-long {
            background: linear-gradient(135deg, #00ff88, #00cc66);
        }

        .btn-short {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }

        /* ================= FORMULAIRES ================= */
        .input-group {
            margin: 18px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 15px;
            background: #1a2234;
            border: 1px solid #2a3a5a;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--futures);
            box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.2);
        }

        /* ================= BADGES VOLATILIT√â ================= */
        .volatility-badge {
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 11px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .low-vol {
            background: linear-gradient(135deg, #00cc66, #00994d);
        }

        .medium-vol {
            background: linear-gradient(135deg, #ff9900, #cc7700);
        }

        .high-vol {
            background: linear-gradient(135deg, #ff3366, #cc0044);
        }

        /* ================= NOTES S√âCURIT√â ================= */
        .security-note {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid #9d4edd;
            color: #9d4edd;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            line-height: 1.6;
            font-size: 14px;
        }

        .security-note i {
            font-size: 20px;
        }

        .security-note strong {
            color: #c77dff;
        }

        /* ================= LOGS & HISTORIQUE ================= */
        .trade-log {
            background: #0d1422;
            border-radius: 12px;
            padding: 18px;
            margin-top: 20px;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--card-border);
        }

        .log-entry {
            padding: 12px;
            border-bottom: 1px solid rgba(30, 42, 58, 0.5);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
        }

        .log-entry:hover {
            background: rgba(30, 42, 58, 0.3);
        }

        .log-success {
            color: var(--secondary);
            border-left: 4px solid var(--secondary);
            padding-left: 8px;
        }

        .log-error {
            color: var(--danger);
            border-left: 4px solid var(--danger);
            padding-left: 8px;
        }

        .log-info {
            color: var(--futures);
            border-left: 4px solid var(--futures);
            padding-left: 8px;
        }

        /* ================= POSITIONS ACTIVES ================= */
        .position-card {
            background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(0, 212, 255, 0.05));
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(157, 78, 221, 0.3);
        }

        .position-long {
            border-left: 4px solid #00ff88;
        }

        .position-short {
            border-left: 4px solid #ff416c;
        }

        /* ================= UTILITAIRES ================= */
        .section {
            animation: fadeIn 0.5s ease;
        }

        .hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ================= RESPONSIVE ================= */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .menu {
                width: 100%;
                justify-content: center;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .balance {
                font-size: 36px;
            }
            
            .card {
                padding: 18px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        /* ================= SCROLLBAR ================= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1422;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--futures);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7b2cbf;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-rocket"></i>
                <span>CryptoVision AI</span>
                <span class="lever-badge">20√ó</span>
                <span class="futures-badge">FUTURES</span>
            </div>
            <div class="menu">
                <a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-chart-line"></i> Trading</a>
                <a href="#" onclick="showSection('positions')"><i class="fas fa-layer-group"></i> Positions</a>
                <a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> API Futures</a>
                <a href="#" onclick="showSection('history')"><i class="fas fa-history"></i> Historique</a>
            </div>
        </header>
        
        <!-- SECTION DASHBOARD -->
        <div id="dashboard-section" class="section">
            <div class="dashboard">
                <div class="card">
                    <h2><i class="fas fa-wallet"></i> Compte Futures</h2>
                    <div class="balance" id="balance">0.00 USDT</div>
                    <div class="status" id="connection-status">
                        <i class="fas fa-plug"></i> Lbank Futures: <span id="status-text">D√©connect√©</span>
                    </div>
                    <button class="btn" onclick="connectToLbankFutures()"><i class="fas fa-link"></i> Connecter API Futures</button>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-bolt"></i> Contr√¥le Futures</h2>
                    <div class="input-group">
                        <label>Position size (USDT) <span style="color: #ff9900; font-size: 12px;">√ó20</span></label>
                        <input type="number" id="trade-amount" value="100" min="2">
                        <small style="color: #8a9bb0; display: block; margin-top: 5px;">Exposition r√©elle: <span id="exposure">2,000 USDT</span></small>
                    </div>
                    <div class="input-group">
                        <label>Contrat Futures</label>
                        <select id="trading-pair">
                            <!-- FUTURES PERP√âTUELS -->
                            <option value="BTC_USDT-PERP">BTC/USDT-PERP <span class="volatility-badge low-vol">Faible Vol</span></option>
                            <option value="ETH_USDT-PERP">ETH/USDT-PERP <span class="volatility-badge low-vol">Faible Vol</span></option>
                            <option value="BNB_USDT-PERP">BNB/USDT-PERP <span class="volatility-badge medium-vol">Moyenne Vol</span></option>
                            <option value="SOL_USDT-PERP">SOL/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="XRP_USDT-PERP">XRP/USDT-PERP <span class="volatility-badge medium-vol">Moyenne Vol</span></option>
                            <option value="ADA_USDT-PERP">ADA/USDT-PERP <span class="volatility-badge medium-vol">Moyenne Vol</span></option>
                            <option value="DOGE_USDT-PERP">DOGE/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="DOT_USDT-PERP">DOT/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="MATIC_USDT-PERP">MATIC/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="AVAX_USDT-PERP">AVAX/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="LINK_USDT-PERP">LINK/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="UNI_USDT-PERP">UNI/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="AAVE_USDT-PERP">AAVE/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="SHIB_USDT-PERP">SHIB/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="PEPE_USDT-PERP">PEPE/USDT-PERP <span class="volatility-badge high-vol">Haute Vol</span></option>
                            <option value="GIGGLE_USDT-PERP">GIGGLE/USDT-PERP <span class="volatility-badge high-vol">TR√àS HAUTE VOL</span></option>
                        </select>
                    </div>
                    <div class="security-note">
                        <i class="fas fa-shield-alt"></i> 
                        <strong>CONTRAT FUTURES PERP√âTUEL</strong> - Marge isol√©e obligatoire | Levier 20√ó fixe | Funding rates inclus
                    </div>
                    <div class="security-note" style="background: rgba(255, 193, 7, 0.1); border-color: #ffc107; color: #ffc107;">
                        <i class="fas fa-brain"></i> 
                        <strong>IA EXPERTE FUTURES</strong> - Analyse funding rates | Liquidations | Marge | PnL en temps r√©el
                    </div>
                    <button class="btn btn-green" onclick="startFuturesTrading()"><i class="fas fa-play"></i> D√©marrer Trading Futures</button>
                    <button class="btn btn-red" onclick="stopTrading()"><i class="fas fa-stop"></i> Arr√™ter Trading</button>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> Stats du Cycle</h2>
                    <div id="daily-stats">
                        <p style="color: #8a9bb0; text-align: center; padding: 20px;">
                            <i class="fas fa-sync"></i> Cycle non d√©marr√©
                        </p>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-list-alt"></i> Journal Futures</h2>
                    <div class="trade-log" id="trade-log">
                        <div class="log-entry log-info">Syst√®me Futures pr√™t. Connectez votre API Lbank.</div>
                        <div class="log-entry log-info">IA experte en trading futures avec levier 20√ó obligatoire</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECTION POSITIONS -->
        <div id="positions-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-layer-group"></i> Positions Actives Futures</h2>
                <div id="positions-container">
                    <p style="color: #8a9bb0; text-align: center; padding: 20px;">Aucune position active</p>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-long" onclick="closeAllPositions('LONG')"><i class="fas fa-arrow-up"></i> Fermer tous LONG</button>
                    <button class="btn btn-short" onclick="closeAllPositions('SHORT')"><i class="fas fa-arrow-down"></i> Fermer tous SHORT</button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-calculator"></i> Calculateur Marge</h2>
                <div class="input-group">
                    <label>Montant position (USDT)</label>
                    <input type="number" id="margin-calc-amount" value="100" min="2">
                </div>
                <div class="input-group">
                    <label>Levier</label>
                    <input type="number" id="margin-calc-leverage" value="20" min="1" max="100" disabled>
                </div>
                <div style="background: rgba(157, 78, 221, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #8a9bb0;">Marge requise:</span>
                        <span style="color: #9d4edd; font-weight: bold;" id="margin-required">5.00 USDT</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span style="color: #8a9bb0;">Exposition r√©elle:</span>
                        <span style="color: #00ff88; font-weight: bold;" id="real-exposure">2,000 USDT</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span style="color: #8a9bb0;">Liquidation √†:</span>
                        <span style="color: #ff416c; font-weight: bold;" id="liquidation-price">4.75%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECTION PARAM√àTRES -->
        <div id="settings-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-key"></i> API Futures Lbank</h2>
                <div class="security-note">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>API FUTURES REQUISE</strong> - Utilisez les cl√©s API du compte Futures, pas du compte Spot
                </div>
                <div class="input-group">
                    <label>Cl√© API Futures Lbank</label>
                    <input type="password" id="api-key" placeholder="Cl√© API du compte Futures">
                </div>
                <div class="input-group">
                    <label>Cl√© Secr√®te Futures Lbank</label>
                    <input type="password" id="api-secret" placeholder="Cl√© secr√®te du compte Futures">
                </div>
                <div class="input-group">
                    <label>Mode Marge Futures</label>
                    <select id="margin-mode">
                        <option value="isolated" selected>Marge Isol√©e (OBLIGATOIRE)</option>
                        <option value="cross" disabled>Marge Crois√©e (d√©sactiv√©)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>PIN de s√©curit√©</label>
                    <input type="password" id="pin-code" value="2025" maxlength="4">
                </div>
                <div class="security-note">
                    <i class="fas fa-lock"></i> 
                    <strong>Vos cl√©s sont chiffr√©es localement</strong> - Stock√©es uniquement sur cet appareil
                </div>
                <button class="btn" onclick="saveApiConfig()"><i class="fas fa-save"></i> Enregistrer Configuration Futures</button>
                <button class="btn btn-red" onclick="clearAllData()"><i class="fas fa-trash"></i> Effacer Toutes les Donn√©es</button>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> Param√®tres Futures</h2>
                <div class="input-group">
                    <label>Stop-loss (%) <span style="color: #ff416c; font-size: 12px;">Futures</span></label>
                    <input type="number" id="stop-loss" value="3" min="1" max="10">
                    <small style="color: #8a9bb0;">Plus agressif en futures (levier 20√ó)</small>
                </div>
                <div class="input-group">
                    <label>Take-profit (%) <span style="color: #00ff88; font-size: 12px;">Futures</span></label>
                    <input type="number" id="take-profit" value="8" min="3" max="20">
                    <small style="color: #8a9bb0;">Adapt√© au levier 20√ó</small>
                </div>
                <div class="input-group">
                    <label>Levier Futures</label>
                    <input type="number" id="leverage" value="20" min="1" max="100" disabled>
                    <small style="color: #ff9900; display: block; margin-top: 5px;">Levier 20√ó FIXE pour tous les contrats</small>
                </div>
                <div class="input-group">
                    <label>Funding Rate Alert (%)</label>
                    <input type="number" id="funding-alert" value="0.01" min="0.001" max="0.1" step="0.001">
                    <small style="color: #8a9bb0;">Alerte si funding rate d√©passe cette valeur</small>
                </div>
                <button class="btn" onclick="saveTradingConfig()"><i class="fas fa-save"></i> Sauvegarder Param√®tres Futures</button>
            </div>
        </div>
        
        <!-- SECTION HISTORIQUE -->
        <div id="history-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-history"></i> Historique Futures</h2>
                <div id="history-container">
                    <p style="color: #8a9bb0; text-align: center; padding: 20px;">Aucun trade historique</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION FUTURES =================
        const FUTURES_CONFIG = {
            LEVERAGE: 20,                   // LEVIER 20√ó OBLIGATOIRE FUTURES
            MARGIN_MODE: 'isolated',        // MARGE ISOL√âE OBLIGATOIRE
            EXCHANGE: 'Lbank Futures',
            API_VERSION: 'v2',
            CONTRACT_TYPE: 'PERPETUAL',     // Contrats perp√©tuels
            SETTLEMENT: 'USDT',             // R√®glement en USDT
            VERSION: '4.0.0',
            SECURITY_LEVEL: 'ULTRA_HIGH'
        };

        // ================= LIMITES TRADING FUTURES =================
        const TRADING_LIMITS = {
            MIN_DAILY_TRADES: 6,           // Minimum 6 trades par cycle
            MAX_DAILY_TRADES: 10,          // Maximum 10 trades par cycle
            MAX_DAILY_LOSSES: 3,           // Maximum 3 trades perdants par cycle
            MIN_POSITION_SIZE: 2,          // Minimum 2 USDT par position
            CYCLE_HOURS: 24,               // Cycle de 24h depuis l'activation
            MAX_EXPOSURE: 100000,          // Exposition maximale (marge √ó levier)
            MIN_MARGIN_RATIO: 0.05         // Marge minimum 5% (levier 20√ó)
        };

        // ================= PAIRES FUTURES DISPONIBLES =================
        const FUTURES_PAIRS = {
            'BTC_USDT-PERP': { symbol: 'BTCUSDT', tickSize: 0.1, minQty: 0.001, volatility: 'LOW' },
            'ETH_USDT-PERP': { symbol: 'ETHUSDT', tickSize: 0.01, minQty: 0.01, volatility: 'LOW' },
            'BNB_USDT-PERP': { symbol: 'BNBUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'MEDIUM' },
            'SOL_USDT-PERP': { symbol: 'SOLUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'HIGH' },
            'XRP_USDT-PERP': { symbol: 'XRPUSDT', tickSize: 0.0001, minQty: 1, volatility: 'MEDIUM' },
            'ADA_USDT-PERP': { symbol: 'ADAUSDT', tickSize: 0.0001, minQty: 1, volatility: 'MEDIUM' },
            'DOGE_USDT-PERP': { symbol: 'DOGEUSDT', tickSize: 0.0001, minQty: 10, volatility: 'HIGH' },
            'DOT_USDT-PERP': { symbol: 'DOTUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'HIGH' },
            'MATIC_USDT-PERP': { symbol: 'MATICUSDT', tickSize: 0.0001, minQty: 1, volatility: 'HIGH' },
            'AVAX_USDT-PERP': { symbol: 'AVAXUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'HIGH' },
            'LINK_USDT-PERP': { symbol: 'LINKUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'HIGH' },
            'UNI_USDT-PERP': { symbol: 'UNIUSDT', tickSize: 0.001, minQty: 0.1, volatility: 'HIGH' },
            'AAVE_USDT-PERP': { symbol: 'AAVEUSDT', tickSize: 0.01, minQty: 0.01, volatility: 'HIGH' },
            'SHIB_USDT-PERP': { symbol: 'SHIBUSDT', tickSize: 0.00000001, minQty: 10000, volatility: 'HIGH' },
            'PEPE_USDT-PERP': { symbol: 'PEPEUSDT', tickSize: 0.00000001, minQty: 10000, volatility: 'HIGH' },
            'GIGGLE_USDT-PERP': { symbol: 'GIGGLEUSDT', tickSize: 0.0001, minQty: 10, volatility: 'EXTREME' }
        };

        // ================= CLASSE IA EXPERTE FUTURES =================
        class FuturesTradingAI {
            constructor() {
                this.LEVERAGE = 20;
                this.MARGIN_MODE = 'isolated';
                this.futuresKnowledge = {
                    longShort: 'expert',           // Conna√Æt LONG/SHORT
                    leverageManagement: 'expert',  // Gestion levier
                    marginManagement: 'expert',    // Gestion marge
                    positionSizing: 'expert',      // Taille position
                    riskManagement: 'expert',      // Gestion risque
                    fundingRates: 'advanced',      // Comprend funding rates
                    liquidation: 'advanced',       // Comprend liquidations
                    hedging: 'intermediate',       // Couvertures
                    volatility: 'expert'           // Analyse volatilit√©
                };
                
                this.analysisTime = {
                    LOW: 1500,      // 1.5s pour futures stables
                    MEDIUM: 2500,   // 2.5s pour moyenne volatilit√©
                    HIGH: 4000,     // 4s pour haute volatilit√©
                    EXTREME: 6000   // 6s pour tr√®s haute volatilit√©
                };
            }

            // D√©termine le niveau de volatilit√© d'une paire futures
            getVolatilityLevel(pair) {
                const pairInfo = FUTURES_PAIRS[pair];
                return pairInfo ? pairInfo.volatility : 'MEDIUM';
            }

            // Analyse futures avanc√©e
            async analyzeFuturesMarket(pair, marketData) {
                const volatility = this.getVolatilityLevel(pair);
                const analysisTime = this.analysisTime[volatility];
                
                console.log(`üîç IA Futures analyse ${pair} (${volatility} volatilit√©) pendant ${analysisTime/1000}s...`);
                
                // Simulation analyse IA futures
                await this.simulateFuturesAnalysis(analysisTime);
                
                // Analyse profonde selon volatilit√©
                const analysisDepth = {
                    LOW: 2,      // Analyse √ó2 pour stables
                    MEDIUM: 3,   // Analyse √ó3 pour moyenne
                    HIGH: 4,     // Analyse √ó4 pour haute
                    EXTREME: 5   // Analyse √ó5 pour tr√®s haute
                }[volatility];

                return this.deepFuturesAnalysis(pair, analysisDepth);
            }

            // Simulation analyse futures
            simulateFuturesAnalysis(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Analyse futures pouss√©e
            deepFuturesAnalysis(pair, depth) {
                const analyses = [];
                
                for (let i = 1; i <= depth; i++) {
                    analyses.push({
                        level: i,
                        futuresIndicators: this.generateFuturesIndicators(pair, i),
                        confidence: Math.min(0.65 + (i * 0.08), 0.92),
                        riskAssessment: this.assessFuturesRisk(pair, i),
                        marginSafety: this.calculateMarginSafety(i),
                        liquidationRisk: this.calculateLiquidationRisk(pair, i)
                    });
                }

                // D√©cision finale bas√©e sur analyses multiples
                const finalDecision = this.makeFuturesDecision(analyses, pair);
                
                // FORCER CONFIGURATION FUTURES
                finalDecision.leverage = this.LEVERAGE;
                finalDecision.marginMode = this.MARGIN_MODE;
                finalDecision.positionType = 'PERPETUAL';
                
                return {
                    decision: finalDecision,
                    analysisDepth: depth,
                    volatility: this.getVolatilityLevel(pair),
                    timestamp: new Date().toISOString(),
                    futuresSpecific: {
                        fundingRateImpact: this.estimateFundingRateImpact(pair),
                        liquidationPrice: this.calculateLiquidationPrice(pair, finalDecision.action),
                        marginRatio: TRADING_LIMITS.MIN_MARGIN_RATIO,
                        maxDrawdown: this.calculateMaxDrawdown(finalDecision.action)
                    }
                };
            }

            // Indicateurs sp√©cifiques futures
            generateFuturesIndicators(pair, level) {
                const baseIndicators = ['Funding Rate', 'Open Interest', 'Liquidation Levels', 'Basis', 'Volume Profile'];
                const advancedIndicators = ['Liquidations Heatmap', 'Margin Ratio Trend', 'Position Skew', 'Delta Neutral', 'Gamma Exposure'];
                const expertIndicators = ['Perpetual Arbitrage', 'Cross-Market Spread', 'Hedging Efficiency', 'Risk Reversal', 'Volatility Smile'];
                
                let indicators = [...baseIndicators];
                
                if (level >= 2) indicators.push('Mark Price', 'Index Price', 'Premium/Discount');
                if (level >= 3) indicators.push(...advancedIndicators.slice(0, 3));
                if (level >= 4) indicators.push(...advancedIndicators.slice(3));
                if (level >= 5) indicators.push(...expertIndicators);
                
                return indicators;
            }

            // √âvaluation risque futures
            assessFuturesRisk(pair, level) {
                const volatility = this.getVolatilityLevel(pair);
                const riskBase = {
                    LOW: 0.25,
                    MEDIUM: 0.45,
                    HIGH: 0.65,
                    EXTREME: 0.85
                }[volatility];

                // Plus d'analyse = meilleure √©valuation risque
                const riskReduction = level * 0.06;
                return Math.max(0.15, riskBase - riskReduction);
            }

            // Calcul s√©curit√© marge
            calculateMarginSafety(level) {
                const baseSafety = 0.7;
                const safetyIncrease = level * 0.05;
                return Math.min(0.95, baseSafety + safetyIncrease);
            }

            // Calcul risque liquidation
            calculateLiquidationRisk(pair, level) {
                const volatility = this.getVolatilityLevel(pair);
                const riskBase = {
                    LOW: 0.1,
                    MEDIUM: 0.25,
                    HIGH: 0.4,
                    EXTREME: 0.6
                }[volatility];

                const riskReduction = level * 0.07;
                return Math.max(0.05, riskBase - riskReduction);
            }

            // D√©cision futures
            makeFuturesDecision(analyses, pair) {
                // Moyenne pond√©r√©e des confidences
                let totalWeight = 0;
                let weightedConfidence = 0;
                
                analyses.forEach((analysis, index) => {
                    const weight = (index + 1) * 2; // Plus de poids aux analyses profondes
                    weightedConfidence += analysis.confidence * weight;
                    totalWeight += weight;
                });
                
                const avgConfidence = weightedConfidence / totalWeight;
                
                // D√©cision bas√©e sur confiance et analyse la plus profonde
                const deepestAnalysis = analyses[analyses.length - 1];
                
                // Pour futures, on est plus prudent
                let action;
                if (avgConfidence > 0.7) {
                    action = 'BUY'; // LONG
                } else if (avgConfidence < 0.3) {
                    action = 'SELL'; // SHORT
                } else {
                    action = 'HOLD';
                }
                
                return {
                    action: action,
                    confidence: avgConfidence,
                    leverage: this.LEVERAGE,
                    marginMode: this.MARGIN_MODE,
                    stopLoss: 3, // Plus serr√© en futures
                    takeProfit: 8, // Adapt√© au levier
                    analysisLevel: analyses.length,
                    riskLevel: deepestAnalysis.riskAssessment,
                    marginSafety: deepestAnalysis.marginSafety,
                    liquidationRisk: deepestAnalysis.liquidationRisk,
                    positionSide: action === 'BUY' ? 'LONG' : 'SHORT'
                };
            }

            // Estimation impact funding rate
            estimateFundingRateImpact(pair) {
                const volatility = this.getVolatilityLevel(pair);
                const impacts = {
                    LOW: 0.0005,    // 0.05%
                    MEDIUM: 0.001,  // 0.1%
                    HIGH: 0.002,    // 0.2%
                    EXTREME: 0.003  // 0.3%
                };
                return impacts[volatility];
            }

            // Calcul prix liquidation
            calculateLiquidationPrice(pair, action) {
                // Simulation bas√©e sur levier 20√ó
                const leverage = this.LEVERAGE;
                const marginRatio = TRADING_LIMITS.MIN_MARGIN_RATIO;
                
                // Formule simplifi√©e
                if (action === 'BUY') {
                    return (1 - (marginRatio * 0.8)).toFixed(4); // -4% pour LONG
                } else {
                    return (1 + (marginRatio * 0.8)).toFixed(4); // +4% pour SHORT
                }
            }

            // Calcul max drawdown
            calculateMaxDrawdown(action) {
                return action === 'BUY' ? 0.04 : 0.04; // 4% max drawdown
            }

            // Validation configuration futures
            validateFuturesConfig(leverage, marginMode) {
                if (leverage !== this.LEVERAGE) {
                    throw new Error(`ERREUR FUTURES: Levier ${this.LEVERAGE}√ó obligatoire. Re√ßu: ${leverage}√ó`);
                }
                if (marginMode !== this.MARGIN_MODE) {
                    throw new Error(`ERREUR FUTURES: Marge ${this.MARGIN_MODE} obligatoire. Re√ßu: ${marginMode}`);
                }
                return true;
            }
        }

        // ================= CLASSE API LBANK FUTURES =================
        class LbankFuturesAPI {
            constructor(apiKey, apiSecret) {
                this.apiKey = apiKey;
                this.apiSecret = apiSecret;
                this.baseURL = 'https://api.lbkex.com/v2';
                this.futuresURL = 'https://api.lbkex.com/v2/futures';
            }

            // Validation configuration futures
            validateFuturesConfig(leverage, marginMode) {
                if (leverage !== FUTURES_CONFIG.LEVERAGE) {
                    throw new Error(`ERREUR FUTURES: Levier ${FUTURES_CONFIG.LEVERAGE}√ó obligatoire. Re√ßu: ${leverage}√ó`);
                }
                if (marginMode !== FUTURES_CONFIG.MARGIN_MODE) {
                    throw new Error(`ERREUR FUTURES: Marge ${FUTURES_CONFIG.MARGIN_MODE} obligatoire. Re√ßu: ${marginMode}`);
                }
                return true;
            }

            // Cr√©ation signature pour API futures
            createFuturesSignature(params) {
                const sortedParams = Object.keys(params).sort()
                    .map(key => `${key}=${params[key]}`)
                    .join('&');
                return CryptoJS.HmacSHA256(sortedParams, this.apiSecret).toString(CryptoJS.enc.Hex);
            }

            // Ouvrir position futures
            async openFuturesPosition(symbol, side, amount) {
                try {
                    this.validateFuturesConfig(FUTURES_CONFIG.LEVERAGE, FUTURES_CONFIG.MARGIN_MODE);
                    
                    const timestamp = Date.now();
                    const params = {
                        api_key: this.apiKey,
                        symbol: symbol,
                        type: 'MARKET',              // Market order pour futures
                        side: side.toUpperCase(),    // BUY ou SELL
                        amount: amount.toString(),
                        leverage: FUTURES_CONFIG.LEVERAGE.toString(),
                        margin_mode: FUTURES_CONFIG.MARGIN_MODE,
                        position_side: side === 'BUY' ? 'LONG' : 'SHORT',
                        time_in_force: 'GTC',        // Good Till Cancelled
                        timestamp: timestamp.toString()
                    };

                    params.sign = this.createFuturesSignature(params);

                    // Simulation appel API futures Lbank
                    console.log(`üìà FUTURES: ${side} ${amount} ${symbol} - Levier ${FUTURES_CONFIG.LEVERAGE}√ó - Marge ${FUTURES_CONFIG.MARGIN_MODE}`);
                    
                    return {
                        success: true,
                        orderId: 'FUT_' + Date.now(),
                        symbol: symbol,
                        side: side,
                        amount: amount,
                        leverage: FUTURES_CONFIG.LEVERAGE,
                        marginMode: FUTURES_CONFIG.MARGIN_MODE,
                        positionSide: side === 'BUY' ? 'LONG' : 'SHORT',
                        message: `Position ${side === 'BUY' ? 'LONG' : 'SHORT'} ouverte - Levier ${FUTURES_CONFIG.LEVERAGE}√ó`,
                        futuresData: {
                            markPrice: (Math.random() * 10000 + 100).toFixed(2),
                            indexPrice: (Math.random() * 10000 + 100).toFixed(2),
                            fundingRate: (Math.random() * 0.002 - 0.001).toFixed(6),
                            liquidationPrice: this.calculateLiquidationPrice(side, amount),
                            marginRatio: TRADING_LIMITS.MIN_MARGIN_RATIO
                        }
                    };
                } catch (error) {
                    console.error('‚ùå ERREUR FUTURES:', error);
                    return { 
                        success: false, 
                        error: error.message,
                        code: 'FUTURES_ERROR'
                    };
                }
            }

            // Fermer position futures
            async closeFuturesPosition(positionId, symbol, side) {
                try {
                    const timestamp = Date.now();
                    const params = {
                        api_key: this.apiKey,
                        symbol: symbol,
                        type: 'MARKET',
                        side: side === 'LONG' ? 'SELL' : 'BUY', // Inverse pour fermer
                        amount: '0', // Fermeture totale
                        reduce_only: 'true',
                        timestamp: timestamp.toString()
                    };

                    params.sign = this.createFuturesSignature(params);

                    console.log(`üìâ FUTURES: Fermeture ${positionId} - ${symbol} ${side}`);
                    
                    return {
                        success: true,
                        orderId: 'CLOSE_' + Date.now(),
                        positionId: positionId,
                        message: `Position ${side} ferm√©e`,
                        pnl: (Math.random() * 20 - 5).toFixed(2) // PnL simul√©
                    };
                } catch (error) {
                    console.error('‚ùå ERREUR FERMETURE:', error);
                    return { success: false, error: error.message };
                }
            }

            // Calcul prix liquidation (simul√©)
            calculateLiquidationPrice(side, amount) {
                const leverage = FUTURES_CONFIG.LEVERAGE;
                const margin = amount / leverage;
                const liquidationBuffer = 0.04; // 4% buffer
    
                if (side === 'BUY') {
                    return (100 * (1 - liquidationBuffer)).toFixed(2); // -4% pour LONG
                } else {
                    return (100 * (1 + liquidationBuffer)).toFixed(2); // +4% pour SHORT
                }
            }

            // R√©cup√©rer balance futures
            async getFuturesBalance() {
                try {
                    const timestamp = Date.now();
                    const params = {
                        api_key: this.apiKey,
                        timestamp: timestamp.toString()
                    };

                    params.sign = this.createFuturesSignature(params);

                    // Simulation balance futures
                    return {
                        success: true,
                        total: 1000 + Math.random() * 5000,
                        available: 800 + Math.random() * 4000,
                        margin: 200 + Math.random() * 1000,
                        currency: 'USDT'
                    };
                } catch (error) {
                    console.error('‚ùå ERREUR BALANCE:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // ================= GESTIONNAIRE DE S√âCURIT√â =================
        class SecurityManager {
            constructor() {
                this.PIN = '2025';
                this.MAX_ATTEMPTS = 3;
                this.attempts = 0;
            }

            verifyPin(inputPin) {
                if (inputPin === this.PIN) {
                    this.attempts = 0;
                    return true;
                } else {
                    this.attempts++;
                    if (this.attempts >= this.MAX_ATTEMPTS) {
                        throw new Error('Trop de tentatives. Red√©marrez l\'application.');
                    }
                    throw new Error(`PIN incorrect. Tentatives: ${this.attempts}/${this.MAX_ATTEMPTS}`);
                }
            }

            encryptData(data) {
                try {
                    return CryptoJS.AES.encrypt(JSON.stringify(data), this.PIN + 'futures2025').toString();
                } catch (error) {
                    console.error('Erreur chiffrement:', error);
                    return null;
                }
            }

            decryptData(encryptedData) {
                try {
                    const bytes = CryptoJS.AES.decrypt(encryptedData, this.PIN + 'futures2025');
                    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                } catch (error) {
                    console.error('Erreur d√©chiffrement:', error);
                    return null;
                }
            }
        }

        // ================= √âTAT APPLICATION FUTURES =================
        let appState = {
            isConnected: false,
            isTrading: false,
            tradeInProgress: false,
            apiKey: '',
            apiSecret: '',
            balance: 0,
            availableBalance: 0,
            marginBalance: 0,
            positions: [],
            tradeHistory: [],
            futuresAPI: null,
            securityManager: new SecurityManager(),
            tradingAI: new FuturesTradingAI(),
            dailyStats: {
                tradeCount: 0,
                winningTrades: 0,
                losingTrades: 0,
                totalPnL: 0,
                lastResetDate: null
            },
            activationTime: null,
            cycleEndTime: null,
            futuresSettings: {
                leverage: 20,
                marginMode: 'isolated',
                stopLoss: 3,
                takeProfit: 8,
                fundingAlert: 0.01
            }
        };

        // ================= FONCTIONS UI =================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateUI() {
            document.getElementById('balance').textContent = appState.balance.toFixed(2) + ' USDT';
            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            if (appState.isConnected) {
                statusEl.className = 'status status-online';
                statusText.textContent = 'Connect√© Futures';
            } else {
                statusEl.className = 'status status-offline';
                statusText.textContent = 'D√©connect√©';
            }
            
            updatePositions();
            updateHistory();
            updateDailyStats();
            updateExposure();
        }

        // ================= ALARMES SONORES =================
        function playWinSound() {
            try {
                document.getElementById('win-sound').currentTime = 0;
                document.getElementById('win-sound').play();
            } catch (e) { console.log('Son gagnant:', e); }
        }

        function playLossSound() {
            try {
                document.getElementById('loss-sound').currentTime = 0;
                document.getElementById('loss-sound').play();
            } catch (e) { console.log('Son perdant:', e); }
        }

        function playLimitSound() {
            try {
                document.getElementById('limit-sound').currentTime = 0;
                document.getElementById('limit-sound').play();
            } catch (e) { console.log('Son limite:', e); }
        }

        // ================= GESTION CYCLE 24H =================
        function setupTradingCycle() {
            appState.activationTime = new Date();
            appState.cycleEndTime = new Date();
            appState.cycleEndTime.setHours(appState.cycleEndTime.getHours() + TRADING_LIMITS.CYCLE_HOURS);
            
            appState.dailyStats = {
                tradeCount: 0,
                winningTrades: 0,
                losingTrades: 0,
                totalPnL: 0,
                lastResetDate: new Date().toDateString()
            };
            
            logMessage(`üîÑ CYCLE FUTURES D√âMARR√â √† ${appState.activationTime.toLocaleTimeString()}`, 'info');
            logMessage(`‚è∞ Fin du cycle: ${appState.cycleEndTime.toLocaleTimeString()}`, 'info');
            logMessage(`üéØ OBJECTIF: ${TRADING_LIMITS.MIN_DAILY_TRADES}-${TRADING_LIMITS.MAX_DAILY_TRADES} trades futures`, 'info');
            logMessage(`‚ö° Configuration: Levier ${FUTURES_CONFIG.LEVERAGE}√ó | Marge ${FUTURES_CONFIG.MARGIN_MODE}`, 'info');
        }

        function checkCycleEnd() {
            if (!appState.cycleEndTime) return false;
            
            const now = new Date();
            if (now >= appState.cycleEndTime) {
                logMessage('üîÑ CYCLE FUTURES TERMIN√â - 24h √©coul√©es', 'warning');
                playLimitSound();
                
                if (appState.dailyStats.tradeCount < TRADING_LIMITS.MIN_DAILY_TRADES) {
                    logMessage(`‚ùå OBJECTIF NON ATTEINT: ${appState.dailyStats.tradeCount}/${TRADING_LIMITS.MIN_DAILY_TRADES} trades`, 'error');
                } else {
                    logMessage(`‚úÖ CYCLE ACCOMPLI: ${appState.dailyStats.tradeCount} trades futures r√©alis√©s`, 'success');
                }
                
                stopTrading();
                return true;
            }
            
            return false;
        }

        // ================= CONNEXION LBANK FUTURES =================
        async function connectToLbankFutures() {
            if (!appState.apiKey || !appState.apiSecret) {
                alert('Configurez d\'abord vos cl√©s API Futures.');
                showSection('settings');
                return;
            }
            
            logMessage('Connexion Lbank Futures...', 'info');
            
            try {
                // Simulation connexion futures
                const balance = await appState.futuresAPI.getFuturesBalance();
                
                if (balance.success) {
                    appState.isConnected = true;
                    appState.balance = balance.total;
                    appState.availableBalance = balance.available;
                    appState.marginBalance = balance.margin;
                    
                    updateUI();
                    logMessage('‚úÖ Connect√© √† Lbank Futures', 'success');
                    logMessage(`üí∞ Balance: ${appState.balance.toFixed(2)} USDT | Marge: ${appState.marginBalance.toFixed(2)} USDT`, 'info');
                    logMessage('ü§ñ IA experte futures activ√©e - Pr√™te √† trader', 'info');
                } else {
                    logMessage(`‚ùå Erreur connexion: ${balance.error}`, 'error');
                }
            } catch (error) {
                logMessage(`Erreur: ${error.message}`, 'error');
            }
        }

        // ================= CONFIGURATION API =================
        function saveApiConfig() {
            const apiKey = document.getElementById('api-key').value.trim();
            const apiSecret = document.getElementById('api-secret').value.trim();
            const pin = document.getElementById('pin-code').value.trim();
            const marginMode = document.getElementById('margin-mode').value;
            
            try {
                appState.securityManager.verifyPin(pin);
            } catch (error) {
                alert(error.message);
                return;
            }
            
            if (!apiKey || !apiSecret) {
                alert('Veuillez entrer vos cl√©s API Futures Lbank.');
                return;
            }
            
            if (marginMode !== 'isolated') {
                alert('ERREUR: Marge isol√©e obligatoire pour le trading futures.');
                return;
            }
            
            const encrypted = appState.securityManager.encryptData({
                apiKey: apiKey,
                apiSecret: apiSecret,
                marginMode: marginMode,
                timestamp: Date.now()
            });
            
            localStorage.setItem('cryptoai_futures_config', encrypted);
            
            appState.apiKey = apiKey;
            appState.apiSecret = apiSecret;
            appState.futuresAPI = new LbankFuturesAPI(apiKey, apiSecret);
            appState.futuresSettings.marginMode = marginMode;
            
            logMessage('Configuration API Futures enregistr√©e et chiffr√©e.', 'success');
            alert('Configuration Futures sauvegard√©e! Marge isol√©e activ√©e. Levier 20√ó fixe.');
        }

        function loadConfig() {
            try {
                const saved = localStorage.getItem('cryptoai_futures_config');
                if (saved) {
                    const decrypted = appState.securityManager.decryptData(saved);
                    if (decrypted) {
                        appState.apiKey = decrypted.apiKey;
                        appState.apiSecret = decrypted.apiSecret;
                        appState.futuresAPI = new LbankFuturesAPI(decrypted.apiKey, decrypted.apiSecret);
                        appState.futuresSettings.marginMode = decrypted.marginMode || 'isolated';
                        logMessage('Configuration Futures charg√©e.', 'info');
                    }
                }
                
                // Charger param√®tres trading
                const savedSL = localStorage.getItem('cryptoai_stop_loss');
                const savedTP = localStorage.getItem('cryptoai_take_profit');
                const savedFA = localStorage.getItem('cryptoai_funding_alert');
                
                if (savedSL) {
                    document.getElementById('stop-loss').value = savedSL;
                    appState.futuresSettings.stopLoss = parseFloat(savedSL);
                }
                if (savedTP) {
                    document.getElementById('take-profit').value = savedTP;
                    appState.futuresSettings.takeProfit = parseFloat(savedTP);
                }
                if (savedFA) {
                    document.getElementById('funding-alert').value = savedFA;
                    appState.futuresSettings.fundingAlert = parseFloat(savedFA);
                }
                
            } catch (error) {
                logMessage('Chargement config: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è EFFACER TOUTES LES DONN√âES FUTURES?')) {
                localStorage.clear();
                appState = {
                    isConnected: false,
                    isTrading: false,
                    tradeInProgress: false,
                    apiKey: '',
                    apiSecret: '',
                    balance: 0,
                    availableBalance: 0,
                    marginBalance: 0,
                    positions: [],
                    tradeHistory: [],
                    futuresAPI: null,
                    securityManager: new SecurityManager(),
                    tradingAI: new FuturesTradingAI(),
                    dailyStats: {
                        tradeCount: 0,
                        winningTrades: 0,
                        losingTrades: 0,
                        totalPnL: 0,
                        lastResetDate: null
                    },
                    activationTime: null,
                    cycleEndTime: null,
                    futuresSettings: {
                        leverage: 20,
                        marginMode: 'isolated',
                        stopLoss: 3,
                        takeProfit: 8,
                        fundingAlert: 0.01
                    }
                };
                updateUI();
                logMessage('Toutes donn√©es futures effac√©es.', 'info');
            }
        }

        // ================= TRADING FUTURES =================
        async function startFuturesTrading() {
            if (!appState.isConnected) {
                alert('Connectez d\'abord √† Lbank Futures API.');
                return;
            }
            
            try {
                // Validation configuration futures
                appState.tradingAI.validateFuturesConfig(FUTURES_CONFIG.LEVERAGE, FUTURES_CONFIG.MARGIN_MODE);
                
                const amount = parseFloat(document.getElementById('trade-amount').value);
                const pair = document.getElementById('trading-pair').value;
                
                // V√©rification montant minimum
                if (amount < TRADING_LIMITS.MIN_POSITION_SIZE) {
                    alert(`Minimum: ${TRADING_LIMITS.MIN_POSITION_SIZE} USDT pour futures`);
                    return;
                }
                
                // V√©rifier marge disponible
                const requiredMargin = amount / FUTURES_CONFIG.LEVERAGE;
                if (requiredMargin > appState.availableBalance) {
                    alert(`Marge insuffisante. Requis: ${requiredMargin.toFixed(2)} USDT | Disponible: ${appState.availableBalance.toFixed(2)} USDT`);
                    return;
                }
                
                // V√©rifier si un trade est d√©j√† en cours
                if (appState.tradeInProgress) {
                    alert('‚è≥ Une position est d√©j√† en cours. Attendez la fermeture.');
                    return;
                }
                
                // V√©rifier les limites journali√®res
                if (appState.dailyStats.tradeCount >= TRADING_LIMITS.MAX_DAILY_TRADES) {
                    alert(`‚ùå LIMITE ATTEINTE: Maximum ${TRADING_LIMITS.MAX_DAILY_TRADES} trades par cycle`);
                    stopTrading();
                    return;
                }
                
                if (appState.dailyStats.losingTrades >= TRADING_LIMITS.MAX_DAILY_LOSSES) {
                    alert(`üö® ARR√äT AUTOMATIQUE: ${TRADING_LIMITS.MAX_DAILY_LOSSES} trades perdants atteints`);
                    stopTrading();
                    return;
                }
                
                // D√©marrer le cycle si premier trade
                if (!appState.activationTime) {
                    setupTradingCycle();
                }
                
                appState.isTrading = true;
                
                const pairInfo = FUTURES_PAIRS[pair];
                logMessage(`üöÄ TRADING FUTURES D√âMARR√â - ${pair}`, 'success');
                logMessage(`üìä Contrat: ${pairInfo.symbol} | Tick: ${pairInfo.tickSize} | Min: ${pairInfo.minQty}`, 'info');
                logMessage(`‚ö° Levier ${FUTURES_CONFIG.LEVERAGE}√ó | Marge ${FUTURES_CONFIG.MARGIN_MODE}`, 'info');
                logMessage(`üí∞ Exposition: ${(amount * FUTURES_CONFIG.LEVERAGE).toFixed(2)} USDT | Marge: ${(amount / FUTURES_CONFIG.LEVERAGE).toFixed(2)} USDT`, 'info');
                
                // D√©marrer le trading futures
                futuresTradingLoop(pair, amount);
                
            } catch (error) {
                logMessage(`ERREUR FUTURES: ${error.message}`, 'error');
                alert('Configuration futures incorrecte!');
            }
        }

        function stopTrading() {
            appState.isTrading = false;
            appState.tradeInProgress = false;
            logMessage('üõë Trading Futures arr√™t√©.', 'info');
        }

        async function futuresTradingLoop(pair, amount) {
            if (!appState.isTrading || appState.tradeInProgress) return;
            if (checkCycleEnd()) return;
            
            try {
                appState.tradeInProgress = true;
                
                // 1. ANALYSE FUTURES AVANC√âE
                logMessage(`üîç IA Futures analyse ${pair}...`, 'info');
                const analysis = await appState.tradingAI.analyzeFuturesMarket(pair, {});
                
                // 2. V√âRIFICATION CONFIGURATION FUTURES
                appState.tradingAI.validateFuturesConfig(analysis.decision.leverage, analysis.decision.marginMode);
                
                // 3. EX√âCUTION SI D√âCISION POSITIVE
                if (analysis.decision.action !== 'HOLD') {
                    const pairInfo = FUTURES_PAIRS[pair];
                    const result = await appState.futuresAPI.openFuturesPosition(
                        pairInfo.symbol, 
                        analysis.decision.action, 
                        amount
                    );
                    
                    if (result.success) {
                        const trade = {
                            id: result.orderId,
                            pair: pair,
                            symbol: pairInfo.symbol,
                            action: analysis.decision.action,
                            positionSide: result.positionSide,
                            amount: amount,
                            leverage: analysis.decision.leverage,
                            marginMode: analysis.decision.marginMode,
                            analysisDepth: analysis.analysisDepth,
                            volatility: analysis.volatility,
                            entryPrice: result.futuresData.markPrice,
                            fundingRate: result.futuresData.fundingRate,
                            liquidationPrice: result.futuresData.liquidationPrice,
                            profit: (Math.random() * 15 - 3).toFixed(2),
                            timestamp: new Date().toLocaleTimeString(),
                            message: `${result.message}`,
                            futuresSpecific: analysis.futuresSpecific
                        };
                        
                        appState.tradeHistory.unshift(trade);
                        
                        // Mettre √† jour les stats
                        appState.dailyStats.tradeCount++;
                        appState.availableBalance -= (amount / FUTURES_CONFIG.LEVERAGE);
                        appState.marginBalance += (amount / FUTURES_CONFIG.LEVERAGE);
                        
                        if (parseFloat(trade.profit) > 0) {
                            appState.dailyStats.winningTrades++;
                            appState.dailyStats.totalPnL += parseFloat(trade.profit);
                            playWinSound();
                            logMessage(`üéâ FUTURES GAGNANT! ${trade.positionSide} Profit: ${trade.profit}%`, 'success');
                        } else {
                            appState.dailyStats.losingTrades++;
                            appState.dailyStats.totalPnL += parseFloat(trade.profit);
                            playLossSound();
                            logMessage(`‚ö†Ô∏è FUTURES PERDANT! ${trade.positionSide} Perte: ${trade.profit}%`, 'error');
                            
                            // V√©rifier si limite de pertes atteinte
                            if (appState.dailyStats.losingTrades >= TRADING_LIMITS.MAX_DAILY_LOSSES) {
                                playLimitSound();
                                logMessage(`üö® ARR√äT: ${TRADING_LIMITS.MAX_DAILY_LOSSES} trades perdants atteints!`, 'error');
                                stopTrading();
                            }
                        }
                        
                        // V√©rifier si limite de trades atteinte
                        if (appState.dailyStats.tradeCount >= TRADING_LIMITS.MAX_DAILY_TRADES) {
                            playLimitSound();
                            logMessage(`üìä LIMITE: ${TRADING_LIMITS.MAX_DAILY_TRADES} trades atteints`, 'warning');
                        }
                        
                        // Afficher le trade
                        const logMsg = `${trade.timestamp} - ${trade.positionSide} ${trade.pair} - ${trade.amount} USDT`;
                        const logMsg2 = `Levier ${trade.leverage}√ó | Marge ${trade.marginMode} | Prix: ${trade.entryPrice}`;
                        const logMsg3 = `Funding: ${(trade.fundingRate * 100).toFixed(4)}% | Liq: ${trade.liquidationPrice}`;
                        logMessage(logMsg, parseFloat(trade.profit) > 0 ? 'success' : 'info');
                        logMessage(logMsg2, 'info');
                        logMessage(logMsg3, 'info');
                        
                        updateHistory();
                        updateDailyStats();
                        updateExposure();
                    }
                } else {
                    logMessage(`‚è∏Ô∏è IA Futures d√©cide HOLD pour ${pair}`, 'info');
                }
                
                appState.tradeInProgress = false;
                
                // V√©rifier si on doit continuer
                if (appState.isTrading && 
                    appState.dailyStats.tradeCount < TRADING_LIMITS.MAX_DAILY_TRADES &&
                    appState.dailyStats.losingTrades < TRADING_LIMITS.MAX_DAILY_LOSSES &&
                    !checkCycleEnd()) {
                    
                    const volatility = appState.tradingAI.getVolatilityLevel(pair);
                    const intervals = {
                        LOW: 20000,      // 20 secondes
                        MEDIUM: 15000,    // 15 secondes
                        HIGH: 10000,      // 10 secondes
                        EXTREME: 8000     // 8 secondes
                    };
                    
                    setTimeout(() => futuresTradingLoop(pair, amount), intervals[volatility]);
                }
                
            } catch (error) {
                logMessage(`Erreur futures: ${error.message}`, 'error');
                appState.tradeInProgress = false;
            }
        }

        // ================= GESTION POSITIONS =================
        async function closeAllPositions(side) {
            if (!appState.isConnected) {
                alert('Connectez d\'abord √† Lbank Futures.');
                return;
            }
            
            if (confirm(`Fermer toutes les positions ${side}?`)) {
                logMessage(`Fermeture toutes positions ${side}...`, 'info');
                // Simulation fermeture
                logMessage(`‚úÖ Toutes positions ${side} ferm√©es`, 'success');
            }
        }

        function updatePositions() {
            const container = document.getElementById('positions-container');
            if (appState.positions.length === 0) {
                container.innerHTML = '<p style="color: #8a9bb0; text-align: center; padding: 20px;">Aucune position active</p>';
            } else {
                // Afficher les positions actives
            }
        }

        // ================= AFFICHAGE STATS =================
        function updateDailyStats() {
            const container = document.getElementById('daily-stats');
            if (!container) return;
            
            let statsHTML = '';
            
            if (!appState.activationTime) {
                statsHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="color: #8a9bb0; margin-bottom: 10px;">
                            <i class="fas fa-rocket"></i> Cycle Futures non d√©marr√©
                        </div>
                        <div style="font-size: 14px; color: #9d4edd;">
                            Activez le trading pour d√©marrer un cycle de 24h
                        </div>
                    </div>
                `;
            } else {
                const now = new Date();
                const timeLeft = appState.cycleEndTime - now;
                const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                statsHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                        <div style="background: rgba(157, 78, 221, 0.1); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #9d4edd;">
                                ${appState.dailyStats.tradeCount}<span style="font-size: 14px; color: #8a9bb0;">/${TRADING_LIMITS.MAX_DAILY_TRADES}</span>
                            </div>
                            <div style="font-size: 12px; color: #8a9bb0;">Trades Futures</div>
                        </div>
                        <div style="background: rgba(255, 65, 108, 0.1); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: ${appState.dailyStats.losingTrades < 2 ? '#00ff88' : appState.dailyStats.losingTrades < 3 ? '#ff9900' : '#ff416c'}">
                                ${appState.dailyStats.losingTrades}<span style="font-size: 14px; color: #8a9bb0;">/${TRADING_LIMITS.MAX_DAILY_LOSSES}</span>
                            </div>
                            <div style="font-size: 12px; color: #8a9bb0;">Pertes Futures</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 212, 255, 0.1); border-radius: 8px;">
                        <div style="font-size: 12px; color: #00d4ff; margin-bottom: 5px;">
                            <i class="fas fa-clock"></i> Temps restant cycle
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: #ffffff;">
                            ${hoursLeft}h ${minutesLeft}min
                        </div>
                        <div style="font-size: 10px; color: #8a9bb0;">
                            Fin: ${appState.cycleEndTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; text-align: center;">
                        <div style="font-size: 11px; color: ${appState.dailyStats.tradeCount >= TRADING_LIMITS.MIN_DAILY_TRADES ? '#00ff88' : '#ff416c'}">
                            <i class="fas ${appState.dailyStats.tradeCount >= TRADING_LIMITS.MIN_DAILY_TRADES ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                            ${appState.dailyStats.tradeCount >= TRADING_LIMITS.MIN_DAILY_TRADES ? 'Objectif minimum atteint' : `Encore ${TRADING_LIMITS.MIN_DAILY_TRADES - appState.dailyStats.tradeCount} trade(s) requis`}
                        </div>
                        <div style="font-size: 11px; color: #ff9900; margin-top: 5px;">
                            PnL: ${appState.dailyStats.totalPnL > 0 ? '+' : ''}${appState.dailyStats.totalPnL.toFixed(2)}%
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = statsHTML;
        }

        function updateExposure() {
            const amount = parseFloat(document.getElementById('trade-amount').value) || 100;
            const exposure = amount * FUTURES_CONFIG.LEVERAGE;
            document.getElementById('exposure').textContent = exposure.toFixed(2) + ' USDT';
            
            // Mettre √† jour calculateur marge
            const marginRequired = amount / FUTURES_CONFIG.LEVERAGE;
            document.getElementById('margin-required').textContent = marginRequired.toFixed(2) + ' USDT';
            document.getElementById('real-exposure').textContent = exposure.toFixed(2) + ' USDT';
            document.getElementById('liquidation-price').textContent = '¬±4.00%';
        }

        // ================= UTILITAIRES =================
        function updateHistory() {
            const container = document.getElementById('history-container');
            if (appState.tradeHistory.length === 0) {
                container.innerHTML = '<p style="color: #8a9bb0; text-align: center; padding: 20px;">Aucun trade historique</p>';
            } else {
                container.innerHTML = appState.tradeHistory.slice(0, 10).map(trade => `
                    <div style="background: #1a2234; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid ${parseFloat(trade.profit) > 0 ? '#00ff88' : '#ff416c'};">
                        <strong>${trade.pair}</strong> - ${trade.positionSide} - ${trade.amount} USDT<br>
                        <small>Levier: ${trade.leverage}√ó | Marge: ${trade.marginMode} | Entry: ${trade.entryPrice}</small><br>
                        <small>Funding: ${(trade.fundingRate * 100).toFixed(4)}% | Liq: ${trade.liquidationPrice}</small><br>
                        <small>Profit: ${trade.profit}% | ${trade.timestamp}</small>
                    </div>
                `).join('');
            }
        }

        function logMessage(message, type = 'info') {
            const log = document.getElementById('trade-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            log.prepend(entry);
            
            if (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
            
            updateDailyStats();
        }

        function saveTradingConfig() {
            const stopLoss = document.getElementById('stop-loss').value;
            const takeProfit = document.getElementById('take-profit').value;
            const fundingAlert = document.getElementById('funding-alert').value;
            
            localStorage.setItem('cryptoai_stop_loss', stopLoss);
            localStorage.setItem('cryptoai_take_profit', takeProfit);
            localStorage.setItem('cryptoai_funding_alert', fundingAlert);
            
            appState.futuresSettings.stopLoss = parseFloat(stopLoss);
            appState.futuresSettings.takeProfit = parseFloat(takeProfit);
            appState.futuresSettings.fundingAlert = parseFloat(fundingAlert);
            
            logMessage(`Configuration Futures: SL ${stopLoss}% / TP ${takeProfit}% / Funding Alert ${fundingAlert}%`, 'success');
        }

        // ================= INITIALISATION =================
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            updateExposure();
            
            // √âcouter changement montant pour mettre √† jour exposition
            document.getElementById('trade-amount').addEventListener('input', updateExposure);
            document.getElementById('margin-calc-amount').addEventListener('input', updateExposure);
            
            updateUI();
            logMessage('CryptoVision AI Futures 4.0 charg√©e', 'info');
            logMessage('üöÄ Syst√®me Futures activ√© - Contrats perp√©tuels', 'info');
            logMessage('‚ö° Configuration: Levier 20√ó FIXE | Marge isol√©e OBLIGATOIRE', 'info');
            logMessage('ü§ñ IA experte futures: LONG/SHORT | Marge | Liquidations | Funding', 'info');
            logMessage('üéØ Cycle 24h: 6-10 trades max | 3 pertes max = arr√™t auto', 'info');
        });
    </script>
</body>
</html>
